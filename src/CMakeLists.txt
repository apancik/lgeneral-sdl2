# CMake build for the main lgeneral executable

file(GLOB_RECURSE LG_SRCS CONFIGURE_DEPENDS
        "${CMAKE_CURRENT_SOURCE_DIR}/*.c"
)

# Include util sources so functions like locale_init() are available
file(GLOB UTIL_SRCS CONFIGURE_DEPENDS
    "${PROJECT_SOURCE_DIR}/util/*.c"
)
# On non-Linux platforms, prefer the generic `paths.c` implementation.
if(NOT CMAKE_SYSTEM_NAME STREQUAL "Linux")
    list(REMOVE_ITEM UTIL_SRCS "${PROJECT_SOURCE_DIR}/util/paths-linux.c")
endif()
list(APPEND LG_SRCS ${UTIL_SRCS})

add_executable(lgeneral ${LG_SRCS})

# Include project root and util so generated headers (config.h, localize.h) are found
target_include_directories(lgeneral PRIVATE
    ${CMAKE_CURRENT_SOURCE_DIR}
    ${PROJECT_SOURCE_DIR}
    ${PROJECT_SOURCE_DIR}/util
)

target_compile_definitions(lgeneral PRIVATE _GNU_SOURCE)

# If config.h was generated by ./configure, expose HAVE_CONFIG_H
if(EXISTS ${PROJECT_SOURCE_DIR}/config.h)
    target_compile_definitions(lgeneral PRIVATE HAVE_CONFIG_H)
endif()

if(USE_SDL)
    # Prefer SDL 1.x via sdl-config if present (project targets SDL 1.x API)
    find_program(SDL_CONFIG sdl-config)
    if(SDL_CONFIG)
        message(STATUS "Found sdl-config at ${SDL_CONFIG}; using SDL 1.x")
        execute_process(COMMAND ${SDL_CONFIG} --cflags
            OUTPUT_VARIABLE SDL_CFLAGS OUTPUT_STRIP_TRAILING_WHITESPACE)
        execute_process(COMMAND ${SDL_CONFIG} --libs
            OUTPUT_VARIABLE SDL_LIBS OUTPUT_STRIP_TRAILING_WHITESPACE)
        if(SDL_CFLAGS)
            separate_arguments(SDL_CFLAG_LIST UNIX_COMMAND "${SDL_CFLAGS}")
            target_compile_options(lgeneral PRIVATE ${SDL_CFLAG_LIST})
        endif()
        if(SDL_LIBS)
            separate_arguments(SDL_LIB_LIST UNIX_COMMAND "${SDL_LIBS}")
            target_link_libraries(lgeneral PRIVATE ${SDL_LIB_LIST})
        endif()
    else()
        find_package(SDL2 QUIET)
        if(SDL2_FOUND)
            target_include_directories(lgeneral PRIVATE ${SDL2_INCLUDE_DIRS})
            target_link_libraries(lgeneral PRIVATE ${SDL2_LIBRARIES})
            message(STATUS "SDL2 found: linking SDL2 to lgeneral")
        else()
            message(STATUS "SDL not found: building without SDL. Set -DUSE_SDL=OFF to silence this message.")
        endif()
    endif()
endif()

# Try to find SDL_mixer (SDL2_mixer or SDL_mixer) via pkg-config so audio.c can use Mix_OpenAudio
if(USE_SDL)
    find_package(PkgConfig QUIET)
    if(PkgConfig_FOUND)
        # Prefer SDL1 mixer package name first to match sdl-config (SDL 1.x)
        pkg_check_modules(SDL_MIXER QUIET SDL_mixer)
        if(NOT SDL_MIXER_FOUND)
            pkg_check_modules(SDL_MIXER QUIET SDL2_mixer)
        endif()
        if(SDL_MIXER_FOUND)
            # If we found an SDL2-based mixer via pkg-config but sdl-config
            # (SDL 1.x) is present, prefer the SDL2 headers/libs to avoid API
            # mismatches. Clear SDL_CONFIG so we don't add SDL 1.x cflags/libs.
            if(SDL_CONFIG)
                # If sdl-config (SDL 1.x) is present, prefer its cflags/includes
                # to keep the SDL1 API visible (e.g., when using sdl12-compat).
                # But audio.c still needs the mixer include dirs; add them only
                # to that source's compile flags to avoid polluting global headers.
                if(SDL_MIXER_CFLAGS)
                    # pkg-config provides CFLAGS as a semicolon list; convert
                    # to a space-separated string suitable for COMPILE_FLAGS.
                    string(REPLACE ";" " " _mixer_cflags "${SDL_MIXER_CFLAGS}")
                    set_source_files_properties(${CMAKE_CURRENT_SOURCE_DIR}/audio.c PROPERTIES COMPILE_FLAGS "${_mixer_cflags}")
                endif()
            else()
                # Only add mixer include dirs when we didn't use sdl-config
                target_include_directories(lgeneral PRIVATE ${SDL_MIXER_INCLUDE_DIRS})
            endif()
            # Enable sound-related source via WITH_SOUND compile definition
            target_compile_definitions(lgeneral PRIVATE WITH_SOUND)
            target_link_libraries(lgeneral PRIVATE ${SDL_MIXER_LIBRARIES})
            message(STATUS "Found SDL_mixer via pkg-config; linking mixer to lgeneral")
        else()
            message(STATUS "SDL_mixer not found via pkg-config; audio may not work at runtime")
        endif()
    else()
        message(STATUS "PkgConfig not available: cannot auto-find SDL_mixer")
    endif()
endif()

target_link_libraries(lgeneral PRIVATE m)
# link gettext (libintl) if present
find_library(INTL_LIB intl)
if(INTL_LIB)
    target_link_libraries(lgeneral PRIVATE ${INTL_LIB})
endif()

set_target_properties(lgeneral PROPERTIES
        RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin
)

# Copy runtime data directories from source tree into the build `bin` directory
# so running the built executable finds themes, sounds, scenarios, etc.
set(LGENERAL_DATA_DIRS
    themes
    scenarios
    campaigns
    nations
    units
    sounds
    gfx
    maps
    terrain
    music
    ai_modules
)
foreach(_dir IN LISTS LGENERAL_DATA_DIRS)
    if(EXISTS ${PROJECT_SOURCE_DIR}/src/${_dir})
        add_custom_command(TARGET lgeneral POST_BUILD
            COMMAND ${CMAKE_COMMAND} -E make_directory ${CMAKE_BINARY_DIR}/bin/${_dir}
            COMMAND ${CMAKE_COMMAND} -E copy_directory
                    ${PROJECT_SOURCE_DIR}/src/${_dir}
                    ${CMAKE_BINARY_DIR}/bin/${_dir}
        )
    endif()
endforeach()
